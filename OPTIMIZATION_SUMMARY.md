# üöÄ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£ Optimize LLM Service

## ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏•‡∏±‡∏Å

### 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏≤‡∏Å 32b ‡πÄ‡∏õ‡πá‡∏ô 14b

**‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:**
- `backend/.env` - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô `AI_MODEL_NAME=qwen2.5-coder:14b`
- `backend/.env.example` - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï default model
- `backend/app/core/settings.py` - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï default model

**‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå:**
- ‡πÉ‡∏ä‡πâ RAM ‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á (~8-10GB ‡πÅ‡∏ó‡∏ô ~16-20GB)
- ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ 32b ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 2-3 ‡πÄ‡∏ó‡πà‡∏≤
- Model size ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á (~8GB ‡πÅ‡∏ó‡∏ô ~18GB)
- ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏î‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô technical analysis

### 2. Optimize LLM Service (`llm_service.py`)

#### Data Filtering
- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô `_filter_relevant_data()` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
- ‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ LLM ‡∏ï‡∏≤‡∏° analysis type:
  - **security_audit**: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ users, acl, snmp, ssh
  - **performance_review**: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ interfaces (limit 30), stp, routing
  - **network_topology**: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ interfaces ‡∏ó‡∏µ‡πà‡∏°‡∏µ IP/description, neighbors, routing
  - **‡∏≠‡∏∑‡πà‡∏ô‡πÜ**: Limit large arrays ‡πÄ‡∏õ‡πá‡∏ô 50 items

#### Prompt Optimization
- ‡πÉ‡∏ä‡πâ compact JSON format (`separators=(',', ':')`) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î tokens
- ‡∏•‡∏î original_content limit ‡∏à‡∏≤‡∏Å 5000 ‡πÄ‡∏õ‡πá‡∏ô 3000 characters
- ‡∏ó‡∏≥‡πÉ‡∏´‡πâ prompt ‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô

#### Model Parameters
- ‡∏•‡∏î temperature ‡∏à‡∏≤‡∏Å 0.4 ‡πÄ‡∏õ‡πá‡∏ô 0.3 (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤, focused ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
- ‡∏•‡∏î top_p ‡∏à‡∏≤‡∏Å 0.9 ‡πÄ‡∏õ‡πá‡∏ô 0.85 (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤)
- ‡πÄ‡∏û‡∏¥‡πà‡∏° `num_predict: 2048` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î max tokens

#### Timeout
- ‡∏•‡∏î timeout ‡∏à‡∏≤‡∏Å 600s ‡πÄ‡∏õ‡πá‡∏ô 300s (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤)

### 3. Optimize Topology Service (`topology_service.py`)

#### Data Reduction
- ‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô devices ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô max 20 devices
- ‡∏•‡∏î interfaces per device ‡∏à‡∏≤‡∏Å 20 ‡πÄ‡∏õ‡πá‡∏ô 15
- ‡∏•‡∏î neighbors per device ‡∏à‡∏≤‡∏Å 20 ‡πÄ‡∏õ‡πá‡∏ô 15
- ‡∏Å‡∏£‡∏≠‡∏á interfaces ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ IP/description/neighbor

#### Prompt Optimization
- ‡πÉ‡∏ä‡πâ compact format ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ä‡πà‡∏ô `IP:192.168.1.1` ‡πÅ‡∏ó‡∏ô `IP address: 192.168.1.1`)
- ‡∏•‡∏î description length ‡πÄ‡∏õ‡πá‡∏ô 50 characters
- ‡∏ó‡∏≥‡πÉ‡∏´‡πâ instructions ‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô

#### Model Parameters
- ‡∏•‡∏î top_p ‡∏à‡∏≤‡∏Å 0.9 ‡πÄ‡∏õ‡πá‡∏ô 0.85
- ‡πÄ‡∏û‡∏¥‡πà‡∏° `num_predict: 2048`

#### Timeout
- ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout ‡∏à‡∏≤‡∏Å 300s ‡πÄ‡∏õ‡πá‡∏ô 450s (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö topology ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö 14b)

## ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á

### Performance Improvements
- **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß**: ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° 2-3 ‡πÄ‡∏ó‡πà‡∏≤ (‡∏à‡∏≤‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• 14b)
- **Token Usage**: ‡∏•‡∏î‡∏•‡∏á 30-50% (‡∏à‡∏≤‡∏Å data filtering ‡πÅ‡∏•‡∏∞ prompt optimization)
- **Memory Usage**: ‡∏•‡∏î‡∏•‡∏á ~50% (‡∏à‡∏≤‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤)
- **Response Time**: ‡∏•‡∏î‡∏•‡∏á‡∏à‡∏≤‡∏Å 300-600s ‡πÄ‡∏õ‡πá‡∏ô 60-180s (‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)

### Resource Requirements
- **RAM**: ~8-10GB (‡∏•‡∏î‡∏•‡∏á‡∏à‡∏≤‡∏Å ~16-20GB)
- **Model Size**: ~8GB (‡∏•‡∏î‡∏•‡∏á‡∏à‡∏≤‡∏Å ~18GB)
- **Disk Space**: ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î ~10GB

## ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### Pull ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏´‡∏°‡πà

```bash
# Pull ‡πÇ‡∏°‡πÄ‡∏î‡∏• 14b
./pull-llm-model.sh

# ‡∏´‡∏£‡∏∑‡∏≠
docker exec mnp-ollama-prod ollama pull qwen2.5-coder:14b
```

### Restart Services

```bash
# Restart backend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î configuration ‡πÉ‡∏´‡∏°‡πà
docker-compose restart backend

# ‡∏´‡∏£‡∏∑‡∏≠
docker-compose -f docker-compose.prod.yml restart backend
```

### ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

```bash
# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö health check
curl http://localhost:8000/health/llm

# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö analysis
curl http://localhost:8000/docs
```

## Troubleshooting

### ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á timeout

1. ‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô devices ‡πÉ‡∏ô topology (‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 20)
2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ñ‡∏π‡∏Å pull ‡πÅ‡∏•‡πâ‡∏ß: `docker exec mnp-ollama-prod ollama list`
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö logs: `docker logs mnp-backend-prod`

### ‡∏ñ‡πâ‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏û‡∏≠

‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 32b ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç `.env`:
```env
AI_MODEL_NAME=qwen2.5-coder:32b
```

## ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á 14b Model

1. **‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤**: Inference time ‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏ß‡πà‡∏≤ 2-3 ‡πÄ‡∏ó‡πà‡∏≤
2. **‡πÉ‡∏ä‡πâ Resource ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤**: RAM ‡πÅ‡∏•‡∏∞ Disk space ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤
3. **‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏î‡∏µ**: ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô technical analysis
4. **‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö Production**: ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á performance ‡πÅ‡∏•‡∏∞ cost

## ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á

- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö network ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å (>20 devices) ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á
- ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ 32b model
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
